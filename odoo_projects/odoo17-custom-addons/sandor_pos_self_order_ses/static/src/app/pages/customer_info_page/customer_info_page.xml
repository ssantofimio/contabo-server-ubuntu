<?xml version="1.0" encoding="UTF-8"?>
<templates id="template" xml:space="preserve">
    <t t-name="sandor_pos_self_order_ses.CustomerInfoPage">
        <div class="customer-info-content bg-view overflow-y-auto flex-grow-1">
            
            <!-- POS HEADER BAR -->
            <div class="pos-top-bar d-flex align-items-center justify-content-between p-2 border-bottom bg-white sticky-top shadow-sm" style="height: 60px;">
                <div class="d-flex align-items-center h-100">
                    <button class="btn btn-secondary fw-bold px-3 px-md-4 rounded-1 h-100 d-flex align-items-center transition-basic" t-on-click="() => state.isSearching ? this.router.back() : state.isSearching = true">
                        <i class="fa fa-chevron-left me-2"></i>
                        <span t-esc="state.isSearching ? 'Descartar' : 'Atrás'"/>
                    </button>
                </div>
                
                <h4 class="m-0 fw-bold text-dark d-none d-md-block text-uppercase letter-spacing-1">
                    <t t-if="state.isSearching">Identificación</t>
                    <t t-else="">Registro de Cliente</t>
                </h4>
                
                <div class="d-flex align-items-center h-100">
                    <t t-if="state.isSearching">
                        <button class="btn btn-primary fw-bold px-3 px-md-4 rounded-1 h-100 d-flex align-items-center transition-basic" t-on-click="confirmAndPay" t-att-disabled="!canConfirm()">
                            Confirmar
                            <i class="fa fa-chevron-right ms-2"></i>
                        </button>
                    </t>
                </div>
            </div>

            <div class="checkout-form container-fluid p-3 p-md-4" style="max-width: 900px; margin: 0 auto;">
                
                <!-- STEP 1: SEARCH (RETOUCHED TO MATCH IMAGE 1) -->
                <t t-if="state.isSearching">
                    <div class="search-step d-flex flex-column align-items-center justify-content-center py-5">
                        <h2 class="mb-2 fw-bold text-dark mt-4">Identifíquese para continuar</h2>
                        <p class="text-muted mb-5">Ingrese su número de identificación para reconocer sus datos.</p>
                        
                        <div class="search-box-container w-100" style="max-width: 500px;">
                            <label class="form-label small fw-bold text-muted mb-2 letter-spacing-1">NÚMERO DE IDENTIFICACIÓN</label>
                            <div class="input-group input-group-lg shadow-sm border rounded overflow-hidden">
                                <input type="text" class="form-control border-0 px-3" t-model="state.vat" placeholder="NIT / CC" t-on-keydown="(ev) => ev.key === 'Enter' &amp;&amp; this.searchPartner()"/>
                                <button class="btn btn-search px-4 border-0" type="button" t-on-click="searchPartner">
                                    <i class="fa fa-search text-white"></i>
                                </button>
                            </div>
                        </div>

                        <div t-if="state.partner" class="partner-found alert alert-success d-flex align-items-center justify-content-between p-3 mt-5 w-100" style="max-width: 500px;">
                            <div class="text-start">
                                <small class="text-muted d-block">Cliente encontrado:</small>
                                <strong class="fs-5" t-esc="state.partner.name"/>
                            </div>
                            <button class="btn btn-sm btn-link text-success p-0 fw-bold text-decoration-none" t-on-click="() => state.isSearching = false">MODIFICAR DATOS</button>
                        </div>

                        <div t-if="state.searched &amp;&amp; !state.partner" class="alert alert-warning py-3 mt-4 w-100" style="max-width: 500px;">
                            <t t-if="this.selfOrder.table &amp;&amp; this.selfOrder.table.is_busy">
                                <small class="fw-bold">No se encontró un pedido activo para esta identificación. Por favor, verifique el número ingresado.</small>
                            </t>
                            <t t-else="">
                                <small class="fw-bold">No se encontró el número. Por favor, complete su registro.</small>
                                <button class="btn btn-sm btn-outline-dark float-end" t-on-click="() => state.isSearching = false">REGISTRARME</button>
                            </t>
                        </div>
                    </div>
                </t>

                <!-- STEP 2: FULL FORM (POS STYLE) -->
                <t t-else="">
                    <div class="pos-form-container bg-white p-3 p-md-4 rounded shadow-sm border mt-2">
                        
                        <!-- Name Section (Avatar removed) -->
                        <div class="row align-items-center g-3 mb-4 border-bottom pb-4">
                            <div class="col-12">
                                <label class="form-label small fw-bold mb-1">Nombre completo <span class="text-danger">*</span></label>
                                <input type="text" class="form-control form-control-lg bg-light border-0 fw-bold" t-model="state.name" placeholder="Escriba el nombre..."/>
                            </div>
                        </div>

                        <!-- Fields with RESTORED ORDER -->
                        <div class="row g-4">
                            <!-- ID Row -->
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Tipo de identificación <span class="text-danger">*</span></label>
                                <select class="form-select bg-light border-0" t-model="state.id_type_id">
                                    <option value="">Seleccione tipo...</option>
                                    <t t-foreach="this.selfOrder.identification_types || []" t-as="idType" t-key="idType.id">
                                        <option t-att-value="idType.id" t-esc="idType.name"/>
                                    </t>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Número de identificación <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="text" class="form-control bg-light border-0" t-model="state.vat" placeholder="Número de ID..."/>
                                    <button class="btn btn-search-sm" type="button" t-on-click="searchPartner"><i class="fa fa-search text-white"></i></button>
                                </div>
                            </div>

                            <!-- Phone Row -->
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Teléfono</label>
                                <input type="text" class="form-control bg-light border-0" t-model="state.phone" placeholder="Teléfono fijo..."/>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Celular <span class="text-danger">*</span></label>
                                <input type="text" class="form-control bg-light border-0" t-model="state.mobile" placeholder="Número de celular..."/>
                            </div>

                            <!-- Email Row -->
                            <div class="col-12">
                                <label class="form-label small fw-bold">Correo electrónico</label>
                                <input type="email" class="form-control bg-light border-0" t-model="state.email" placeholder="email@ejemplo.com"/>
                            </div>

                            <!-- Address Row -->
                            <div class="col-12">
                                <label class="form-label small fw-bold">Dirección</label>
                                <input type="text" class="form-control bg-light border-0" t-model="state.street" placeholder="Dirección detallada..."/>
                            </div>

                            <!-- Location Row -->
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Ciudad</label>
                                <input type="text" class="form-control bg-light border-0" t-model="state.city" placeholder="Ciudad..."/>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">País</label>
                                <select class="form-select bg-light border-0" t-model="state.country_id">
                                    <option value="">Seleccione país...</option>
                                    <t t-foreach="this.selfOrder.countries || []" t-as="country" t-key="country.id">
                                        <option t-att-value="country.id" t-esc="country.name"/>
                                    </t>
                                </select>
                            </div>

                            <!-- State Row -->
                            <div class="col-12 pb-4">
                                <label class="form-label small fw-bold">Estado / Provincia</label>
                                <select class="form-select bg-light border-0" t-model="state.state_id">
                                    <option value="">Seleccione estado...</option>
                                    <t t-foreach="getStates()" t-as="st" t-key="st.id">
                                        <option t-att-value="st.id" t-esc="st.name"/>
                                    </t>
                                </select>
                            </div>

                            <!-- BOTTOM SAVE BUTTON (IMAGE 2 REQUIREMENT) -->
                            <div class="col-12 mt-4 border-top pt-4 text-center">
                                <button class="btn btn-primary btn-lg w-100 py-3 fw-bold rounded-3 shadow-sm" t-on-click="saveForm" t-att-disabled="!canSaveForm()">
                                    GUARDAR Y CONTINUAR
                                </button>
                                <p class="text-muted mt-2 small">Al guardar, volverá a la pantalla de confirmación.</p>
                            </div>
                        </div>
                    </div>
                </t>

            </div>
        </div>
    </t>
</templates>
